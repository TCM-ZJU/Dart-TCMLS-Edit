<?xml version="1.0" encoding="GBK"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtminsList1/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=GBK" />
  <title>TCMLS</title>  
 <!-- <link type="text/css" rel="stylesheet" href="../demolayout.css"/> -->
  <script type="text/javascript" src="../../script/qooxdoo.js"></script>
  <script type="text/javascript" src="../../script/net.js"></script>
</head>
<body>
<script type="text/javascript" src="../demolayout.js"></script> 
<script type="text/javascript">
  	var currentNode;
  	var action;
  	var std = "";
    window.application.main = function()
    {
    	var href = window.location.href;
    	var headerLen = new String("http://").length;
    	href = href.substr(headerLen, href.length-headerLen);
    	href = 'http://' + href.substr(0, href.indexOf('/')) + '/TCMLSOntoEdit/tcmls.jspa';
 //		var href = 'http://10.214.43.211:8080/TCMLSOntoEdit/demo/test/'
 
	  	var d = this.getClientWindow().getClientDocument();
		//树的操作
		  function handleDragStart(e) 
		  {
			e.addData("QxTreeElement", e.getCurrentTarget());
			e.addAction("move");
			e.startDrag();
		  };

		  function handleDragDrop(e) 
		  {
			var vType = e.getDropDataTypes()[0];
			var vSource = e.getData(vType);
			var vTarget = e.getCurrentTarget();
			
			vSource.getTree().getManager().deselectAll();
			vTarget.add(vSource);
			
			e.stopPropagation();
		  }; 
		  
		  function supportsDrop(vDragCache) {
			return !vDragCache.sourceWidget.contains(this);
		  };

		  function handleDragOver(e)
		  {
			var l = e.getTarget().getLabelObject();
			l.setStyleProperty("textDecoration", "underline");
		  };
		
		  function handleDragOut(e) 
		  {
			var l = e.getTarget().getLabelObject();
			l.removeStyleProperty("textDecoration");
		  };

	  //类树 增加类
      var but_clsCreate = new QxButton("创建");
	  with(but_clsCreate){
      	setTop(20);
      	setLeft(20);
      }

      but_clsCreate.addEventListener("click", function(e)
      {
      	if(null == currentNode)
      		alert("请选择要指定的类");
      	if(currentNode == treeSource)
      		alert("根目录下不允许创建类");
      	else{
      		var folder = new QxTreeFolder("default Cls", "icons/16/Class.gif", "icons/16/Class.gif");
      		folder.setUserData("ID", -1);
			currentNode.add(folder);
			treeSource.setSelectedElement(folder);
			currentNode = folder;
		}
      });
      d.add(but_clsCreate);
      
      //类树 删除类
      var but_clsDelete = new QxButton("删除");
		with(but_clsDelete){
      	setTop(20);
      	setLeft(60);
      }

      but_clsDelete.addEventListener("click", function(e)
      {
      	if(null == currentNode)
      		alert("请选择要删除的类");
      	else{
			if((currentNode.getFirstVisibleChildOfFolder() != null) && (insList.getChildren().length>0))
				alert("不能删除此类！");
			else{
	      		var tmp = currentNode.getParent();
		  		tmp.remove(currentNode);
				if(currentNode.getUserData("ID") != null)
					deleteCls(currentNode.getUserData("ID"));
				currentNode = null;
			}
      	}
      });
      d.add(but_clsDelete);

      var treeSource = new QxTree("中国中医药一体化语言系统", "icons/16/Class.gif", "icons/16/Class.gif");
      with(treeSource)
      {
        setBackgroundColor(255);
        setBorder(QxBorderObject.presets.thinInset);
        setOverflow("auto");

        setHeight(400);
        setTop(48);
        setLeft(20);
        setWidth(200);
        
        addEventListener("dragdrop", handleDragDrop); 
        addEventListener("dragover", handleDragOver);
        addEventListener("dragout", handleDragOut);

        setDropDataTypes(["QxTreeElement"]);
      };
      d.add(treeSource);
     
	  treeSource.getManager().addEventListener("changeSelection", function(e) {
	    currentNode = e.getData().getFirst();
	  	var id = currentNode.getUserData("ID");
//	  	alert(id);
		tCurrentInput.setValue(currentNode._labelObject.getHtml());
		insList.removeAll();
		if(insList.length > 0)
			clearAll();
		clearInsDetail();
		if(currentNode instanceof QxTree){
//			alert("Root");
			if(currentNode.getFirstVisibleChildOfFolder() == null)
				getSubclses(id, true);
		}
		else{
//			alert("Cls");
			if((currentNode.getFirstVisibleChildOfFolder() == null) && (id != null) && (id != -1)) 
				getSubclses(id, false);
		}
		if((id != null) && (id != -1))
			getInstances(id);
		if((currentNode != null) && (currentNode != treeSource)){
			but_insCreate.setEnabled(true);
			but_insDelete.setEnabled(true);
			but_insBrowse.setEnabled(true);
			but_submit.setEnabled(true);
		}	
      });

	  //Cls editor
	  var clsEditor = new QxFieldSet("类 编辑");
      with(clsEditor)
      {
        setTop(420);
        setLeft(20);
        setWidth(200);
        setHeight("auto");
      };
      d.add(clsEditor);
      var tCurrentLabel = new QxAtom("目前编辑类: ");
      with(tCurrentLabel)
      {
        setLeft(0);
        setTop(0);
      };
      clsEditor.add(tCurrentLabel);
      
      var tCurrentInput = new QxTextField;
      with(tCurrentInput)
      {
        setLeft(0);
        setRight(0);
        setTop(20);
        setReadOnly(false);
      };
      clsEditor.add(tCurrentInput);
	  var but_submit = new QxButton("提交");
	  with(but_submit){
      	setTop(40);
      	setLeft(70);
      }
      but_submit.addEventListener("click", function(e)
      {
		//增加权限判断
		var clsName = tCurrentInput.getValue();
		currentNode.setLabel(clsName);
		setCls(currentNode.getUserData("ID"), clsName);
      });
      clsEditor.add(but_submit);
	  but_submit.setEnabled(false);

	  //Instance列表
      var insList = new QxList;      
      insList.set({ top: 48, left: 250, height: 400, width: 150, overflow: "auto" });
	  insList.getManager().setMultiSelection(false);
      d.add(insList);

	  //实例列表 增加实例
      var but_insCreate = new QxButton("创建");
	  with(but_insCreate){
      	setTop(20);
      	setLeft(250);
      }

      but_insCreate.addEventListener("click", function(e)
      {
		if(currentNode instanceof QxTree)
			alert("根目录不允许增加实例");
		else{
			var item = new QxListItem("default"/*, "icons/16/Instance.gif"*/);
			insList.addAtBegin(item);
			insList.getManager().setSelectedItem(item);
			clearInsDetail();
			//新增加的实例只有在编辑完成后点击“提交”后一并保存
		}
      });
      d.add(but_insCreate);
	  but_insCreate.setEnabled(false);
      
      //实例列表 删除实例
      var but_insDelete = new QxButton("删除");
	  with(but_insDelete){
      	setTop(20);
      	setLeft(290);
      }

      but_insDelete.addEventListener("click", function(e)
      {
		var currentItem = insList.getManager().getSelectedItem();
      	if(null == currentItem)
      		alert("请选择要删除的实例！");
      	else{
      		insList.remove(currentItem);
			if(currentItem.getUserData("ID") != null)
				deleteIns(currentItem.getUserData("ID"));
      	}
      });
      d.add(but_insDelete);
	  but_insDelete.setEnabled(false);
	  
	  //实例列表 浏览实例
      var but_insBrowse = new QxButton("浏览");
	  with(but_insBrowse){
      	setTop(20);
      	setLeft(330);
      }

      but_insBrowse.addEventListener("click", function(e)
      {
		var currentItem = insList.getManager().getSelectedItem();
      	if(null == currentItem)
      		alert("请选择要浏览的实例！");
      	else{
      		var id = currentItem.getUserData("ID");
			if(tCurrentConceptInput.getValue() != "")
				clearInsDetail();
//			alert(id);
			if(id != null)
				getInsDetail(id);
	        tCurrentConceptInput.setValue(currentItem.getLabel());
			if(currentItem != null)
				submit.setEnabled(true);
      	}
      });
      d.add(but_insBrowse);
	  but_insBrowse.setEnabled(false);
	  
	  insList.getManager().addEventListener("changeSelection", function(e) {
		var currentItem = insList.getManager().getSelectedItem();
		var id = currentItem.getUserData("ID");
		if(tCurrentConceptInput.getValue() != "")
			clearInsDetail();
//		alert(id);
		if(id != null)
			getInsDetail(id);
        tCurrentConceptInput.setValue(currentItem.getLabel());
		if(currentItem != null)
			submit.setEnabled(true);
	  });
	  
	  var editStatus = new QxTextField;
      with(editStatus)
      {
        setLeft(250);
        setTop(500);
        setWidth(150);

        setReadOnly(false);
      };
	  d.add(editStatus);
	  	          
      var type = new QxList();
	  with(type){
		setTop(10);
		setLeft(20);
		setWidth(150);
		setHeight(200);
		setOverflow("auto");
	  }
	  
	  var rela = new QxList();
	  with(rela){
		setTop(10);
		setLeft(20);
		setWidth(150);
		setHeight(200);
		setOverflow("auto");
	  }
	  rela.getManager().setMultiSelection(false);
	  
	  var source = new QxList();
	  with(source){
		setTop(10);
		setLeft(20);
		setWidth(150);
		setHeight(200);
		setOverflow("auto");
	  }
	  source.getManager().setMultiSelection(false);
	  	    
	  //Instance编辑
	  var commandFrame = new QxFieldSet("InstanceEdit");

      with(commandFrame)
      {
        setTop(20);
        setLeft(450);

        setWidth("auto");
        setHeight("auto");
      };

      d.add(commandFrame);
            
	  //概念词
      var tCurrentConceptLabel = new QxAtom("概念词");

      with(tCurrentConceptLabel)
      {
        setLeft(0);
        setTop(0);
      };

      commandFrame.add(tCurrentConceptLabel);

      var tCurrentConceptInput = new QxTextField;

      with(tCurrentConceptInput)
      {
        setLeft(60);
        setRight(0);
        setTop(0);

        setReadOnly(false);
      };
	  commandFrame.add(tCurrentConceptInput);

	  //编辑名称
	  var tEditorLabel = new QxAtom("编辑名称");

      with(tEditorLabel)
      {
        setLeft(0);
        setTop(30);
      };

      commandFrame.add(tEditorLabel);

      var tEditorInput = new QxTextField;

      with(tEditorInput)
      {
        setLeft(60);
        setRight(0);
        setTop(30);
//        setReadOnly(true);
      };

      commandFrame.add(tEditorInput);	  
	  
	  //词表加工时间
      var tDateLabel = new QxAtom("词表加<br>工时间");

      with(tDateLabel)
      {
        setLeft(0);
        setTop(60);
      };

      commandFrame.add(tDateLabel);

      var tDateInput = new QxTextField;

      with(tDateInput)
      {
        setLeft(60);
        setRight(0);
        setTop(60);
//        setReadOnly(true);
      };
	  commandFrame.add(tDateInput);

      //标准表选择窗口
	  var  stdEditWin = new QxWindow("标准表", "icons/16/editor.png");
	  function getstdEditWin(source, destList){
		  with(stdEditWin) {
			setWidth(200);
			setTop(100);
			setHeight(300);
			setLeft(300);
			setResizeable(false);

			var btnOK = new QxButton("确定", "icons/16/button-ok.png");
			var btnCancel = new QxButton("取消", "icons/16/button-cancel.png");

			btnOK.set({ bottom : 10, right : 10 });
			btnCancel.set({ bottom : 10, left : 10 });

			btnCancel.addEventListener("execute", function(e) {
			  stdEditWin.close();
			});
			btnOK.addEventListener("execute", function(e) {
			  var list = source.getManager().getSelectedItems();
			  for(var i=0; i<list.length; i++){
				  var tmpItem = list[i];
				  var newItem = new QxListItem(tmpItem.getLabel()/*, "icons/16/Instance.gif"*/);
				  newItem.setUserData("ID", tmpItem.getUserData("ID"));
				  destList.add(newItem);
			  }
			  stdEditWin.close();
			});
			add(btnOK, btnCancel);
		  }
		  d.add(stdEditWin);
		  stdEditWin.open();
	  };

	  //语义类型
      var tSmtTypeLabel = new QxAtom("语义类型");

      with(tSmtTypeLabel)
      {
        setLeft(0);
        setTop(110);
      };

	  commandFrame.add(tSmtTypeLabel);

	  var typeFrame = new QxFieldSet("Semantic Type");
      with(typeFrame)
      {
        setTop(90);
        setLeft(60);

        setWidth("auto");
        setHeight("auto");
      };
      commandFrame.add(typeFrame);

	  var typeList = new QxList();
	  with(typeList){
		setTop(30);
		setLeft(5);
		setWidth(150);
		setHeight(60);
		setOverflow("auto");
	  }
	  typeFrame.add(typeList);

      typeList.getManager().setMultiSelection(false);

	  //语义类型列表 增加实例
      var but_typeCreate = new QxButton("添加");
	  with(but_typeCreate){
      	setTop(0);
      	setLeft(40);
      }
      but_typeCreate.addEventListener("click", function(e)
      {
      	stdEditWin.setCaption("语义类型");
      	if(std != null){
 //     		alert(std);
      		if(std == 'rela'){
      			stdEditWin.remove(rela);
      			stdEditWin.add(type);
	      		std = 'type';      	
	      	}
      		else if(std == 'source'){
      			stdEditWin.remove(source);
      			stdEditWin.add(type);
	      		std = 'type';      	
	      	}
	      	else if(std == ''){
	      		stdEditWin.add(type);
	      		std = 'type';
	      	}
      	}
		getstdEditWin(type, typeList);
		getTypes();
      });
      typeFrame.add(but_typeCreate);
      
      //语义类型列表 删除实例
      var but_typeDelete = new QxButton("删除");
	  with(but_typeDelete){
      	setTop(0);
      	setLeft(85);
      }
      but_typeDelete.addEventListener("click", function(e)
      {
		var currentItem = typeList.getManager().getSelectedItem();
      	if(null == currentItem)
      		alert("请选择要删除的语义类型");
      	else{
      		typeList.remove(currentItem);
      	}
      });
      typeFrame.add(but_typeDelete);

	  //语义类型列表 浏览实例
	  var but_typeBrowse = new QxButton("浏览");
	  with(but_typeBrowse){
      	setTop(0);
      	setLeft(130);
      }
      but_typeBrowse.addEventListener("click", function(e)
      {
		var currentItem = typeList.getManager().getSelectedItem();
      	if(null == currentItem)
      		alert("请选择要浏览的语义类型!");
      	else{
			alert(currentItem.getUserData("ID"));
      	}
      });
      typeFrame.add(but_typeBrowse);

	  //概念定义
      var tDefLabel = new QxAtom("概念定义");

      with(tDefLabel)
      {
        setLeft(0);
        setTop(240);
      };

	  commandFrame.add(tDefLabel);

	  var defFrame = new QxFieldSet("Definition");
      with(defFrame)
      {
        setTop(220);
        setLeft(60);

        setWidth("auto");
        setHeight("auto");
      };
      commandFrame.add(defFrame);

	  var defList = new QxList();
	  with(defList){
		setTop(30);
		setLeft(5);
		setWidth(150);
		setHeight(60);
		setOverflow("auto");
	  }
	  defFrame.add(defList);
	  defList.getManager().setMultiSelection(false);
	  
	  //概念定义编辑窗口
	  var  defEditWin = new QxWindow("Definition", "icons/16/editor.png");
      with(defEditWin) {
        setSpace(300, 400, 100, 300);
        
        var defLabel = new QxAtom('定义概念');
        with(defLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:10,left:10,width:'20%'});
        };
        add(defLabel);

        var def = new QxTextArea();
        with (def) {
          set({top:10,right:10,width:'70%'})
        }
        add(def);
		
		//工具书列表 增加实例
        var but_bookCreate = new QxButton("添加");
		with(but_bookCreate){
			setTop(70);
			setLeft(150);
		}
		but_bookCreate.addEventListener("click", function(e)
		{	
			stdEditWin.setCaption("工具书");
			if(std != null){
	//      		alert(std);
	      		if(std == 'rela'){
	      			stdEditWin.remove(rela);
	      			stdEditWin.add(source);
		      		std = 'source';      	
		      	}
	      		else if(std == 'type'){
	      			stdEditWin.remove(type);
	      			stdEditWin.add(source);
		      		std = 'source';      	
		      	}
		      	else if(std == ''){
		      		stdEditWin.add(type);
		      		std = 'type';
		      	}
	      	}
//			stdEditWin.add(source);
			getstdEditWin(source, defSource);
			getBooks();
		});
		add(but_bookCreate);
		  
		//工具书列表 删除实例
		var but_bookDelete = new QxButton("删除");
		with(but_bookDelete){
			setTop(70);
			setLeft(195);
		}
		but_bookDelete.addEventListener("click", function(e)
		{
			var currentItem = defSource.getManager().getSelectedItem();
			if(null == currentItem)
				alert("请选择要删除的工具书");
			else{
				defSource.remove(currentItem);
				var currentDef = defList.getManager().getSelectedItem();
				if(currentDef != null)
					currentDef.setUserData("Source", null);
			}
		});
		add(but_bookDelete);

		//工具书列表 浏览实例
		var but_bookBrowse = new QxButton("浏览");
		with(but_bookBrowse){
			setTop(70);
			setLeft(240);
		}
		but_bookBrowse.addEventListener("click", function(e)
		{
			var currentItem = defSource.getManager().getSelectedItem();
			if(null == currentItem)
				alert("请选择要浏览的工具书!");
			else{
				alert(currentItem.getUserData("ID"));
			}
		});
		add(but_bookBrowse);

        var sourceLabel = new QxAtom('概念定义与来源');
        with(sourceLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:100,left:10,width:'20%'});
        };
        add(sourceLabel);

        var defSource = new QxList();
        with (defSource) {
          set({top:100,right:10,width:'70%',height:50})
        }
        add(defSource);

		var btnOK = new QxButton("确认", "icons/16/button-ok.png");
        var btnCancel = new QxButton("取消", "icons/16/button-cancel.png");

        btnOK.set({ bottom : 10, right : 10 });
        btnCancel.set({ bottom : 10, left : 10 });

        btnCancel.addEventListener("execute", function(e) {
          defEditWin.close();
        });
        btnOK.addEventListener("execute", function(e) {
          defEditWin.close();
		  var currentItem = defList.getManager().getSelectedItem();
		  
		  var definition = def.getValue();
		  var sourceItem = null;
		  if(defSource.getChildren().length > 0)
		  	sourceItem = (defSource.getChildren())[0];
		 		   
		  if((definition == null) || (definition == "") || (sourceItem == null))
		  	alert("信息不全");
		  else{		  			  	  
	          but_defCreate.setEnabled(false);
	          but_defDelete.setEnabled(false);
	          but_defBrowse.setEnabled(false);	
	          
			  if(action == "create"){
				  //新建实例没有id
				  var item = new QxListItem(definition/*, "icons/16/Instance.gif"*/);
	//			  var sourceItem = (defSource.getChildren())[0];
				  item.setUserData("source", sourceItem);
				  item.setUserData("ID", ""+(-1));
				  defList.add(item);
				  defList.getManager().setSelectedItem(item);
			  }
			  else{
				  currentItem.setLabel(definition);
				  currentItem.setUserData("source", sourceItem);
			  }	
		  
			  var sourceID = "";
			  if(sourceItem != null)
			  	sourceID = sourceItem.getUserData("ID");
	//		  var sourceID = (defSource.getChildren())[0].getUserData("ID");
			  var text = "<TCMLS><Definition>"+definition+"</Definition><DefiSource>"+sourceID+"</DefiSource></TCMLS>";
			  
			  var defID;
			  if(action == "create")
			  	defID = -1;
			  else			
				defID = currentItem.getUserData("ID");
//			  alert(text+defID);
			  defIns(defID, text);
		  }
        });

		add(btnOK, btnCancel);
	  }
	  d.add(defEditWin);	

	  //概念定义列表 增加实例
      var but_defCreate = new QxButton("创建");
	  with(but_defCreate){
      	setTop(0);
      	setLeft(40);
      }
      but_defCreate.addEventListener("click", function(e)
      {
		def.setValue("");
		if(!defSource.isEmpty())
			defSource.removeAll();
		defEditWin.open();
		action = "create";
      });
      defFrame.add(but_defCreate);
      
      //概念定义列表 删除实例
      var but_defDelete = new QxButton("删除");
	  with(but_defDelete){
      	setTop(0);
      	setLeft(85);
      }
      but_defDelete.addEventListener("click", function(e)
      {
		var currentItem = defList.getManager().getSelectedItem();
      	if(null == currentItem)
      		alert("请选择要删除的概念定义！");
      	else{
 //     		defDelete(currentItem.getUserData("ID"));
      		defList.remove(currentItem);
      	}
      });
      defFrame.add(but_defDelete);

	  //概念定义列表 浏览实例
      var but_defBrowse = new QxButton("浏览");
	  with(but_defBrowse){
      	setTop(0);
      	setLeft(130);
      }
      but_defBrowse.addEventListener("click", function(e)
      {
		var currentItem = defList.getManager().getSelectedItem();
		if(null == currentItem)
			alert("请选择要浏览的概念定义！");
		else{
			//alert(currentItem.getUserData("ID"));
	//		def.setValue(currentItem.getLabel());
	//		defSource.add(currentItem.getUserData("source"));
			alert(currentItem.getUserData("ID"));
			getDefDetail(currentItem.getUserData("ID"));
			action = "modify";
		}
      });
      defFrame.add(but_defBrowse);

	  //概念释义编辑窗口
	  var  expEditWin = new QxWindow("Explanation", "icons/16/editor.png");
      with(expEditWin) {
        setSpace(300, 400, 100, 300);

        var expLabel = new QxAtom('释义概念');
        with(expLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:10,left:10,width:'20%'});
        };
        add(expLabel);

        var exp = new QxTextArea();
        with (exp) {
          set({top:10,right:10,width:'70%'})
        }
        add(exp);

		//工具书列表 增加实例
        var but_bookCreate = new QxButton("添加");
		with(but_bookCreate){
			setTop(70);
			setLeft(150);
		}
		but_bookCreate.addEventListener("click", function(e)
		{
			stdEditWin.setCaption("工具书");
			if(std != null){
//	      		alert(std);
	      		if(std == 'rela'){
	      			stdEditWin.remove(rela);
	      			stdEditWin.add(source);
		      		std = 'source';      	
		      	}
	      		else if(std == 'type'){
	      			stdEditWin.remove(type);
	      			stdEditWin.add(source);
		      		std = 'source';      	
		      	}
		      	else if(std == ''){
		      		stdEditWin.add(type);
		      		std = 'type';
		      	}
	      	}
//			stdEditWin.add(source);
			getstdEditWin(source, expSource);
			getBooks();
		});
		add(but_bookCreate);
		  
		//工具书列表 删除实例
		var but_bookDelete = new QxButton("删除");
		with(but_bookDelete){
			setTop(70);
			setLeft(195);
		}
		but_bookDelete.addEventListener("click", function(e)
		{
			var currentItem = expSource.getManager().getSelectedItem();
			if(null == currentItem)
				alert("请选择要删除的工具书");
			else{
				expSource.remove(currentItem);
				var currentExp = expList.getManager().getSelectedItem();
				if(currentExp != null)
					currentExp.setUserData("Source", null);
			}
		});
		add(but_bookDelete);

		//工具书列表 浏览实例
		var but_bookBrowse = new QxButton("浏览");
		with(but_bookBrowse){
			setTop(70);
			setLeft(240);
		}
		but_bookBrowse.addEventListener("click", function(e)
		{
			var currentItem = expSource.getManager().getSelectedItem();
			if(null == currentItem)
				alert("请选择要浏览的工具书!");
			else{
				alert(currentItem.getUserData("ID"));
			}
		});
		add(but_bookBrowse);

        var sourceLabel = new QxAtom('概念释义与来源');
        with(sourceLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:100,left:10,width:'20%'});
        };
        add(sourceLabel);

        var expSource = new QxList();
        with (expSource) {
          set({top:100,right:10,width:'70%',height:50})
        }
        add(expSource);


        var btnOK = new QxButton("确认", "icons/16/button-ok.png");
        var btnCancel = new QxButton("取消", "icons/16/button-cancel.png");

        btnOK.set({ bottom : 10, right : 10 });
        btnCancel.set({ bottom : 10, left : 10 });

        btnCancel.addEventListener("execute", function(e) {
          expEditWin.close();
        });
        btnOK.addEventListener("execute", function(e) {
          expEditWin.close();
		  var currentItem = expList.getManager().getSelectedItem();
		  
		  var explanation = exp.getValue();		  
		  var sourceItem = null;
		  if(expSource.getChildren().length > 0)
		  	sourceItem = expSource.getChildren()[0];
		  
		  if((explanation == null) || (explanation == '') || (sourceItem == null))
		  	alert("信息不全");
		  else{		  	  
	          but_expCreate.setEnabled(false);
			  but_expDelete.setEnabled(false);
			  but_expBrowse.setEnabled(false);
		  	  if(action == "create"){
				  //新建实例没有id
				  var item = new QxListItem(explanation/*, "icons/16/Instance.gif"*/);
				  item.setUserData("ID", ""+(-1));
				  item.setUserData("source", sourceItem);
				  expList.add(item);
				  expList.getManager().setSelectedItem(item);
			  }
			  else{
				  currentItem.setLabel(exp.getValue());
				  currentItem.setUserData("source", (expSource.getChildren())[0]);
			  }
			  
			  var sourceID = "";
			  if(sourceItem != null)
			  	sourceID = sourceItem.getUserData("ID");
			  var text = "<TCMLS><Explanation>"+explanation+"</Explanation><DefiSource>"+sourceID+"</DefiSource></TCMLS>";
			  
			  var expID;
			  if(action == "create")		  
				expID = -1;
			  else
				expID = currentItem.getUserData("ID");
//			  alert(text);
			  expIns(expID, text);
		  }
        });

		add(btnOK, btnCancel);
	  }
	  d.add(expEditWin);	

	  //概念释义
      var tExpLabel = new QxAtom("概念释义");

      with(tExpLabel)
      {
        setLeft(0);
        setTop(370);
      };

	  commandFrame.add(tExpLabel);

	  var expFrame = new QxFieldSet("Explanation");
      with(expFrame)
      {
        setTop(350);
        setLeft(60);

        setWidth("auto");
        setHeight("auto");
      };
      commandFrame.add(expFrame);

	  var expList = new QxList();
	  with(expList){
		setTop(30);
		setLeft(5);
		setWidth(150);
		setHeight(60);
		setOverflow("auto");
	  }
	  expFrame.add(expList);

	  //概念释义列表 增加实例
      var but_expCreate = new QxButton("创建");
	  with(but_expCreate){
      	setTop(0);
      	setLeft(40);
      }
      but_expCreate.addEventListener("click", function(e)
      {      	
		exp.setValue("");
		if(!expSource.isEmpty())
			expSource.removeAll();
		expEditWin.open();
		action = "create";
      });
      expFrame.add(but_expCreate);
      
      //概念释义列表 删除实例
      var but_expDelete = new QxButton("删除");
	  with(but_expDelete){
      	setTop(0);
      	setLeft(85);
      }
      but_expDelete.addEventListener("click", function(e)
      {
		currentItem = expList.getManager().getSelectedItem();
      	if(null == currentItem)
      		alert("请选择要删除的概念释义实例!");
      	else{
//      		expDelete(currentItem.getUserData("ID"));
      		expList.remove(currentItem);
      	}
      });
      expFrame.add(but_expDelete);

	  //概念释义列表 浏览实例
      var but_expBrowse = new QxButton("浏览");
	  with(but_expBrowse){
      	setTop(0);
      	setLeft(130);
      }
      but_expBrowse.addEventListener("click", function(e)
      {
		currentItem = expList.getManager().getSelectedItem();
		if(null == currentItem)
			alert("请选择要浏览的概念释义");
		else{
			alert(currentItem.getUserData("ID"));
/*			exp.setValue(currentItem.getLabel());
			expSource.add(currentItem.getUserData("source"));*/
			getExpDetail(currentItem.getUserData("ID"));
		}
		action = "modify";
      });
      expFrame.add(but_expBrowse);

	  //各种相关概念名词编辑窗口
	  var  ceptsEditWin = new QxWindow("Related Concepts", "icons/16/editor.png");
      with(ceptsEditWin) {
        setSpace(300, 400, 100, 300);
		setHeight(380);

        var ceptsLabel = new QxAtom('相关概念名词');
        with(ceptsLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:10,left:10,width:'20%'});
        };
        add(ceptsLabel);

        var cepts = new QxTextArea();
        with (cepts) {
          set({top:10,right:10,width:'70%'})
        }
        add(cepts);

		//工具书列表 增加实例
        var but_bookCreate = new QxButton("添加");
		with(but_bookCreate){
			setTop(50);
			setLeft(150);
		}
		but_bookCreate.addEventListener("click", function(e)
		{
			stdEditWin.setCaption("工具书");
			if(std != null){
//	      		alert(std);
	      		if(std == 'rela'){
	      			stdEditWin.remove(rela);
	      			stdEditWin.add(source);
		      		std = 'source';      	
		      	}
	      		else if(std == 'type'){
	      			stdEditWin.remove(type);
	      			stdEditWin.add(source);
		      		std = 'source';      	
		      	}
		      	else if(std == ''){
		      		stdEditWin.add(type);
		      		std = 'type';
		      	}
	      	}
//			stdEditWin.add(source);
			getstdEditWin(source, relaSource);
			getBooks();
		});
		add(but_bookCreate);
		  
		//工具书列表 删除实例
		var but_bookDelete = new QxButton("删除");
		with(but_bookDelete){
			setTop(50);
			setLeft(195);
		}
		but_bookDelete.addEventListener("click", function(e)
		{
			var currentItem = relaSource.getManager().getSelectedItem();
			if(null == currentItem)
				alert("请选择要删除的工具书");
			else{
				relaSource.remove(currentItem);
				var currentConcept = ceptsList.getManager().getSelectedItem();
				if(currentConcept != null)
					currentConcept.setUserData("Source", null);
			}
		});
		add(but_bookDelete);

		//工具书列表 浏览实例
		var but_bookBrowse = new QxButton("浏览");
		with(but_bookBrowse){
			setTop(50);
			setLeft(240);
		}
		but_bookBrowse.addEventListener("click", function(e)
		{
			var currentItem = relaSource.getManager().getSelectedItem();
			if(null == currentItem)
				alert("请选择要浏览的工具书!");
			else{
				alert(currentItem.getUserData("ID"));
			}
		});
		add(but_bookBrowse);

        var sourceLabel = new QxAtom('语义关系<br>设计来源');
        with(sourceLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:90,left:10,width:'20%'});
        };
        add(sourceLabel);

        var relaSource = new QxList();
        with (relaSource) {
          set({top:90,right:10,width:'70%',height:50})
        }
        add(relaSource);

		var descriptLabel = new QxAtom('关联描述');
        with(descriptLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:150,left:10,width:'20%'});
        };
        add(descriptLabel);

        var descript = new QxTextArea();
        with (descript) {
          set({top:150,right:10,width:'70%'})
        }
        add(descript);
		
		//语义关系列表 增加实例
		var but_relaCreate = new QxButton("添加");
		with(but_relaCreate){
			setTop(200);
			setLeft(150);
		}
		but_relaCreate.addEventListener("click", function(e)
		{
			stdEditWin.setCaption("语义关系");
			if(std != null){
//	      		alert(std);
	      		if(std == 'type'){
	      			stdEditWin.remove(type);
	      			stdEditWin.add(rela);
		      		std = 'rela';      	
		      	}
	      		else if(std == 'source'){
	      			stdEditWin.remove(source);
	      			stdEditWin.add(rela);
		      		std = 'rela';      	
		      	}
		      	else if(std == ''){
		      		stdEditWin.add(type);
		      		std = 'type';
		      	}
	      	}
//			stdEditWin.add(rela);
			getstdEditWin(rela, relaList);
			getRelas();
		});
		add(but_relaCreate);
		  
		//语义关系列表 删除实例
		var but_relaDelete = new QxButton("删除");
		with(but_relaDelete){
			setTop(200);
			setLeft(195);
		}
		but_relaDelete.addEventListener("click", function(e)
		{
			var currentItem = relaList.getManager().getSelectedItem();
			if(null == currentItem)
				alert("请选择要删除的语义类型");
			else{
				relaList.remove(currentItem);
			}
		});
		add(but_relaDelete);

		//语义关系列表 浏览实例
		var but_relaBrowse = new QxButton("浏览");
		with(but_relaBrowse){
			setTop(200);
			setLeft(240);
		}
		but_relaBrowse.addEventListener("click", function(e)
		{
			var currentItem = relaList.getManager().getSelectedItem();
			if(null == currentItem)
				alert("请选择要浏览的语义类型!");
			else{
				alert(currentItem.getUserData("ID"));
			}
		});
		add(but_relaBrowse);

		var relaLabel = new QxAtom('语义关系');
        with(relaLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:240,left:10,width:'20%'});
        };
        add(relaLabel);

        var relaList = new QxList();
        with (relaList) {
          set({top:240,right:10,width:'70%',height:50})
        }
        add(relaList);

        var btnOK = new QxButton("确认", "icons/16/button-ok.png");
        var btnCancel = new QxButton("取消", "icons/16/button-cancel.png");

        btnOK.set({ bottom : 10, right : 10 });
        btnCancel.set({ bottom : 10, left : 10 });

        btnCancel.addEventListener("execute", function(e) {
          ceptsEditWin.close();
        });
        btnOK.addEventListener("execute", function(e) {
          ceptsEditWin.close(); 
		  var currentItem = ceptsList.getManager().getSelectedItem();
		  
		  var concept = cepts.getValue();
		  var sourceItem = null;
		  if(relaSource.getChildren().length > 0)
		  	sourceItem = (relaSource.getChildren())[0];
		  var relaItem = null;
		  if(relaList.getChildren().length > 0)
		  	relaItem = relaList.getChildren()[0];
		  var des = descript.getValue();
		  		  
		  if((concept == null) || (concept == '') || (sourceItem == null) || (relaItem == null) || (des == '') || (des == null)){
		  	alert("信息不全");
		  }
		  else{         
	          but_ceptsCreate.setEnabled(false);
			  but_ceptsDelete.setEnabled(false);
			  but_ceptsBrowse.setEnabled(false);
			  if(action == "create"){
				  var item = new QxListItem(concept/*, "icons/16/Instance.gif"*/);
				  item.setUserData("ID", ""+(-1));
				  item.setUserData("Source", sourceItem);
				  item.setUserData("Rela", relaItem);
				  item.setUserData("Descript", des);
				  ceptsList.add(item);
				  ceptsList.getManager().setSelectedItem(item);
			  }
			  else{
				currentItem.setLabel(concept);
				currentItem.setUserData("Source", sourceItem);
				currentItem.setUserData("Rela", relaItem);
				currentItem.setUserData("Descript", des);
			  }
			  var relaID = "";
			  if(relaItem != null)
			  	relaID = relaItem.getUserData("ID");
			  var sourceID = "";
			  if(sourceItem != null)
			  	sourceID = sourceItem.getUserData("ID");
			  var text = "<TCMLS><RelatedConcept>"+concept+"</RelatedConcept><SemanticSource>"+sourceID+"</SemanticSource><SemanticRela>"+relaID+"</SemanticRela><RelaDescription>"+des+"</RelaDescription></TCMLS>";
			  var ceptsID;
			  if(action != "create")
				ceptsID = currentItem.getUserData("ID");
			  else
				ceptsID = -1;
//			  alert(text);
			  ceptsIns(ceptsID, text);
		  }
        });

		add(btnOK, btnCancel);
	  }
	  d.add(ceptsEditWin);

	  //各种相关概念名词
      var tCeptsLabel = new QxAtom("各种相关<br>概念名词");

      with(tCeptsLabel)
      {
        setLeft(270);//0
        setTop(110);//500
      };

	  commandFrame.add(tCeptsLabel);

	  var ceptsFrame = new QxFieldSet("Related Concepts");
      with(ceptsFrame)
      {
        setTop(90);//480
        setLeft(330);//60

        setWidth("auto");
        setHeight("auto");
      };
      commandFrame.add(ceptsFrame);

	  var ceptsList = new QxList();
	  with(ceptsList){
		setTop(30);
		setLeft(5);
		setWidth(150);
		setHeight(60);
		setOverflow("auto");
	  }
	  ceptsFrame.add(ceptsList);

	  //各种相关概念名词列表 增加实例
      var but_ceptsCreate = new QxButton("创建");
	  with(but_ceptsCreate){
      	setTop(0);
      	setLeft(40);
      }
      but_ceptsCreate.addEventListener("click", function(e)
      {
		cepts.setValue("");
      	descript.setValue("");
		if(!relaSource.isEmpty())
			relaSource.removeAll();
		if(!relaList.isEmpty())
			relaList.removeAll();
		ceptsEditWin.open();
		action = "create";
      });
      ceptsFrame.add(but_ceptsCreate);
      
      //各种相关概念名词列表 删除实例
      var but_ceptsDelete = new QxButton("删除");
	  with(but_ceptsDelete){
      	setTop(0);
      	setLeft(85);
      }
      but_ceptsDelete.addEventListener("click", function(e)
      {
		currentItem = ceptsList.getManager().getSelectedItem();
      	if(null == currentItem)
      		alert("请选择要删除的各种相关概念词!");
      	else{
      	//	ceptsDelete(currentItem.getUserData("ID"));
      		ceptsList.remove(currentItem);
      	}
      });
      ceptsFrame.add(but_ceptsDelete);

	  //各种相关概念名词 浏览实例
      var but_ceptsBrowse = new QxButton("浏览");
	  with(but_ceptsBrowse){
      	setTop(0);
      	setLeft(130);
      }
      but_ceptsBrowse.addEventListener("click", function(e)
      {
		currentItem = ceptsList.getManager().getSelectedItem();
		if(null == currentItem)
			alert("请选择要浏览的各种相关概念词");
		else{
			alert(currentItem.getUserData("ID"));
			getCeptsDetail(currentItem.getUserData("ID"));
/*			cepts.setValue(currentItem.getLabel());
			relaSource.add(currentItem.getUserData("Source"));
			relaList.add(currentItem.getUserData("Rela"));
			descript.setValue(currentItem.getUserData("Descript"));
			ceptsEditWin.open();*/
			action = "modify";
		}
      });
      ceptsFrame.add(but_ceptsBrowse);

	  //名称字符类编辑窗口
	  var  aliasEditWin = new QxWindow("Alias", "icons/16/editor.png");
      with(aliasEditWin) {
        setSpace(300, 400, 100, 300);
		setHeight(350);

        var aliasLabel = new QxAtom('名称');
        with(aliasLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:10,left:10,width:'20%'});
        };
        add(aliasLabel);

        var alias = new QxTextArea();
        with (alias) {
          set({top:10,right:10,width:'70%'})
        }
        add(alias);
		
		//工具书列表 增加实例
        var but_bookCreate = new QxButton("添加");
		with(but_bookCreate){
			setTop(50);
			setLeft(150);
		}
		but_bookCreate.addEventListener("click", function(e)
		{
			stdEditWin.setCaption("工具书");
			if(std != null){
//	      		alert(std);
	      		if(std == 'rela'){
	      			stdEditWin.remove(rela);
	      			stdEditWin.add(source);
		      		std = 'source';      	
		      	}
	      		else if(std == 'type'){
	      			stdEditWin.remove(type);
	      			stdEditWin.add(source);
		      		std = 'source';      	
		      	}
		      	else if(std == ''){
		      		stdEditWin.add(type);
		      		std = 'type';
		      	}
	      	}
//			stdEditWin.add(source);
			getstdEditWin(source, aliasSource);
			getBooks();
		});
		add(but_bookCreate);
		  
		//工具书列表 删除实例
		var but_bookDelete = new QxButton("删除");
		with(but_bookDelete){
			setTop(50);
			setLeft(195);
		}
		but_bookDelete.addEventListener("click", function(e)
		{
			var currentItem = aliasSource.getManager().getSelectedItem();
			if(null == currentItem)
				alert("请选择要删除的工具书");
			else{
				aliasSource.remove(currentItem);
				var currentAlias = aliasList.getManager().getSelectedItem();
				if(currentAlias != null)
					currentAlias.setUserData("Source", null);
			}
		});
		add(but_bookDelete);

		//工具书列表 浏览实例
		var but_bookBrowse = new QxButton("浏览");
		with(but_bookBrowse){
			setTop(50);
			setLeft(240);
		}
		but_bookBrowse.addEventListener("click", function(e)
		{
			var currentItem = aliasSource.getManager().getSelectedItem();
			if(null == currentItem)
				alert("请选择要浏览的工具书!");
			else{
				alert(currentItem.getUserData("ID"));
			}
		});
		add(but_bookBrowse);

        var sourceLabel = new QxAtom('名称来源');
        with(sourceLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:80,left:10,width:'20%'});
        };
        add(sourceLabel);

        var aliasSource = new QxList();
        with (aliasSource) {
          set({top:80,right:10,width:'70%', height:50})
        }
        add(aliasSource);

		var nameDateLabel = new QxAtom('名称命名时间');
        with(nameDateLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:150,left:10,width:'20%'});
        };
        add(nameDateLabel);

        var nameDate = new QxTextField();
        with (nameDate) {
          set({top:150,right:10,width:'70%'})
        }
        add(nameDate);
		
		var nameTypeLabel = new QxAtom('名称类型');
        with(nameTypeLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:180,left:10,width:'20%'});
        };
        add(nameTypeLabel);

        var nameType = new QxTextField();
        with (nameType) {
          set({top:180,right:10,width:'70%'})
        }
        add(nameType);

		var statusLabel = new QxAtom('名称字符类<br>状态');
        with(statusLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:210,left:10,width:'20%'});
        };
        add(statusLabel);

        var aliasStatus = new QxTextField();
        with (aliasStatus) {
          set({top:210,right:10,width:'70%'})
        }
        add(aliasStatus);

		var reasonLabel = new QxAtom('原因');
        with(reasonLabel)
        {
          setHorizontalChildrenAlign('right');
          set({top:240,left:10,width:'20%'});
        };
        add(reasonLabel);

        var aliasReason = new QxTextField();
        with (aliasReason) {
          set({top:240,right:10,width:'70%'})
        }
        add(aliasReason);

        var btnOK = new QxButton("确认", "icons/16/button-ok.png");
        var btnCancel = new QxButton("删除", "icons/16/button-cancel.png");

        btnOK.set({ bottom : 10, right : 10 });
        btnCancel.set({ bottom : 10, left : 10 });

        btnCancel.addEventListener("execute", function(e) {
          aliasEditWin.close();
        });
        btnOK.addEventListener("execute", function(e) {
          aliasEditWin.close(); 
		  currentItem = aliasList.getManager().getSelectedItem();
		  
		  var name = alias.getValue();
		  var date = nameDate.getValue();
		  var type = nameType.getValue();
		  var status = aliasStatus.getValue();
		  var reason = aliasReason.getValue();		 
		  var sourceItem = null;
		  if(aliasSource.getChildren().length > 0)
		  	sourceItem = aliasSource.getChildren()[0];
		  		  
		  if((alias == null) || (alias == '') || (date == null) || (date == '') || (type == null) || 
		  (type == '') || (status == null) || (status == '') || (reason == null) || (reason == '') || (sourceItem == null))
		  	alert("信息不全");
		  else{	        
	          but_aliasCreate.setEnabled(false);
			  but_aliasDelete.setEnabled(false);
			  but_aliasBrowse.setEnabled(false);
			  if(action == "create"){
			  //store
				  var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				  item.setUserData("ID", ""+(-1));
				  item.setUserData("Source", sourceItem);
				  item.setUserData("NameDate", date);			  
				  item.setUserData("NameType", type);
				  item.setUserData("Status", status);
				  item.setUserData("Reason", reason);
				  aliasList.add(item);
				  aliasList.getManager().setSelectedItem(item);
			  }
			  else{
				currentItem.setLabel(name);
				currentItem.setUserData("Source", sourceItem);
				currentItem.setUserData("NameDate", date);			  
				currentItem.setUserData("NameType", type);
	  		    currentItem.setUserData("Status", status);
				currentItem.setUserData("Reason", reason);
			  }
			  var sourceID = "";
			  if(sourceItem != null)
			  	sourceID = sourceItem.getUserData("ID");
			  var text = "<TCMLS><Alias>"+name+"</Alias><NameSource>"+sourceID+"</NameSource><NameTime>"+date+"</NameTime><NameType>"+type+"</NameType><AliasStatus>"+status+"</AliasStatus><Reason>"+reason+"</Reason></TCMLS>";
			  var aliasID=-1;
			  if(action != "create")
				aliasID = currentItem.getUserData("ID");
			  else
				aliasID = -1;
//			  alert(text);
			  aliasIns(aliasID, text);
		  }
        });

		add(btnOK, btnCancel);
	  }
	  d.add(aliasEditWin);

	  //名称字符类
      var tAliasLabel = new QxAtom("名称<br>字符类");

      with(tAliasLabel)
      {
        setLeft(270);//0
        setTop(240);//630
      };

	  commandFrame.add(tAliasLabel);

	  var aliasFrame = new QxFieldSet("Alias");
      with(aliasFrame)
      {
        setTop(220);//610
        setLeft(330);//60

        setWidth("auto");
        setHeight("auto");
      };
      commandFrame.add(aliasFrame);

	  var aliasList = new QxList();
	  with(aliasList){
		setTop(30);
		setLeft(5);
		setWidth(150);
		setHeight(60);
		setOverflow("auto");
	  }
	  aliasFrame.add(aliasList);

	  //名称字符类 增加实例
      var but_aliasCreate = new QxButton("创建");
	  with(but_aliasCreate){
      	setTop(0);
      	setLeft(40);
      }
      but_aliasCreate.addEventListener("click", function(e)
      {
      	alias.setValue("");
      	nameDate.setValue("");
		if(!aliasSource.isEmpty())
			aliasSource.removeAll();
		nameType.setValue("");	
		aliasStatus.setValue("");
		aliasReason.setValue("");
		aliasEditWin.open();
      	action = "create";
      });
      aliasFrame.add(but_aliasCreate);
      
      //名称字符类 删除实例
      var but_aliasDelete = new QxButton("删除");
	  with(but_aliasDelete){
      	setTop(0);
      	setLeft(85);
      }
      but_aliasDelete.addEventListener("click", function(e)
      {
		currentItem = aliasList.getManager().getSelectedItem();
      	if(null == currentItem)
      		alert("请选择要删除的名称字符类实例！");
      	else{
      		aliasList.remove(currentItem);
      	}
      });
      aliasFrame.add(but_aliasDelete);

	  //名称字符类 浏览实例
      var but_aliasBrowse = new QxButton("浏览");
	  with(but_aliasBrowse){
      	setTop(0);
      	setLeft(130);
      }
      but_aliasBrowse.addEventListener("click", function(e)
      {
		currentItem = aliasList.getManager().getSelectedItem();
		if(null == currentItem)
			alert("请选择要浏览的名称字符类的实例！");
		else{
/*			alias.setValue(currentItem.getLabel());
			aliasSource.add(currentItem.getUserData("Source"));
			nameDate.setValue(currentItem.getUserData("NameDate"));
			nameType.setValue(currentItem.getUserData("NameType"));
			aliasStatus.setValue(currentItem.getUserData("Status"));
			aliasReason.setValue(currentItem.getUserData("Reason"));*/
			alert(currentItem.getUserData("ID"));
			getAliasDetail(currentItem.getUserData("ID"));
			action = "modify";
		}
      });
      aliasFrame.add(but_aliasBrowse);

      //概念状态
      var tStatusLabel = new QxAtom("概念状态");
      with(tStatusLabel)
      {
        setLeft(270);//0
        setTop(370);//760
      };
      commandFrame.add(tStatusLabel);
      var status = new QxTextField;
      with(status)
      {
        setLeft(330);//60
        setRight(0);
        setTop(370);//760

        setReadOnly(false);
      };
	  commandFrame.add(status);

	  //原因
	  var tReasonLabel = new QxAtom("状态原因");
      with(tReasonLabel)
      {
        setLeft(270);//0
        setTop(400);//790
      };
      commandFrame.add(tReasonLabel);
      var reason = new QxTextField;
      with(reason)
      {
        setLeft(330);//60
        setRight(0);
        setTop(400);//790

        setReadOnly(false);
      };
	  commandFrame.add(reason);

	  var submit = new QxButton("提交");
	  with(submit){
      	setTop(480);//820
      	setLeft(250);//100
      }
	  submit.setEnabled(false);

      submit.addEventListener("click", function(e)
      {	
      	var finished = true;
		var item = insList.getManager().getSelectedItem();
		if(item.getLabel() != tCurrentConceptInput.getValue()){
			item.setLabel(tCurrentConceptInput.getValue());
		}
		if((tCurrentConceptInput.getValue() == null) || (tCurrentConceptInput.getValue() == '') || (tEditorInput.getValue() == null) ||
		(tEditorInput.getValue() == '') || (tDateInput.getValue() == null) || (tDateInput.getValue() == '') || 
		(status.getValue() == null) || (status.getValue() == '') || (reason.getValue() == null) || (reason.getValue() == '')){
			finished = false;
		}
		var text = "<TCMLS><ConceptName>"+tCurrentConceptInput.getValue()+"</ConceptName><EditAuthor>"+tEditorInput.getValue()+"</EditAuthor><EditTime>"+tDateInput.getValue()+"</EditTime><ConceptStatus>"+status.getValue()+"</ConceptStatus><Reason>"+reason.getValue()+"</Reason>";
		
		var list = typeList.getChildren();
		if(list.length == 0){
			finished = false;
		}
		for(var i=0; i<list.length; i++)
			text = text + "<SemanticType>" + list[i].getUserData("ID") + "</SemanticType>";

		list = defList.getChildren();
		if(list.length == 0){
			finished = false;
		}
		for(var i=0; i<list.length; i++)
			text = text + "<Definition>" + list[i].getUserData("ID") + "</Definition>";

		list = expList.getChildren();
		if(list.length == 0){
			finished = false;
		}
		for(var i=0; i<list.length; i++)
			text = text + "<Explanation>" + list[i].getUserData("ID") + "</Explanation>";

		list = ceptsList.getChildren();
		if(list.length == 0){
			finished = false;
		}
		for(var i=0; i<list.length; i++)
			text = text + "<RelatedConcepts>" + list[i].getUserData("ID") + "</RelatedConcepts>";
	
		list = aliasList.getChildren();
		if(list.length == 0){
			finished = false;
		}
		for(var i=0; i<list.length; i++)
			text = text + "<Alias>" + list[i].getUserData("ID") + "</Alias>";
		text = text + "</TCMLS>";
//		alert(text);
		
		if(finished){
			var conceptID = -1;
			conceptID = item.getUserData("ID");
			clsID = currentNode.getUserData("ID");
			conceptIns(conceptID, clsID, text);
		}
		else			
			alert("信息不全");
      });
      commandFrame.add(submit);

	  
/**********************************************************************/
		//与服务器端的交互函数以及一些全局函数
		
		function clearAll(){
			insList.removeAll();
//			clearInsDetail();
		};

		function clearInsDetail(){
			tCurrentConceptInput.setValue("");
			tEditorInput.setValue("");
			tDateInput.setValue("");
			if(typeList.getChildren().length > 0)
				typeList.removeAll();
			if(defList.getChildren().length > 0)
				defList.removeAll();
			if(expList.getChildren().length > 0)
				expList.removeAll();
			if(ceptsList.getChildren().length > 0)
				ceptsList.removeAll();
			if(aliasList.getChildren().length > 0)
				aliasList.removeAll();
			status.setValue("");
			reason.setValue("");
		};

		function getSubclses(clsID, isRoot){
			editStatus.setValue("正在获取类的信息……");
			var strParams = 'type=subclses' + '&clsid=' + clsID + '&isRoot=' + isRoot; 
			var url = href + '?' + strParams;
			alert(url);
			var loader1 = new net.ContentLoader(url,setSubclses,null,"POST",null); 
		};
		  
		function setSubclses(){			
//			alert("get");
      		var text = this.req.responseText; 
//			text = text.documentElement;
			var parser = new DOMParser();
			text = parser.parseFromString(text, "text/xml");
			var list = text.getElementsByTagName("clsID");
			for(var i=0; i<list.length; i++){
				var clsID = text.documentElement.getElementsByTagName("clsID")[i].firstChild.data
				var clsName = text.documentElement.getElementsByTagName("clsName")[i].firstChild.data;
				var node;
				node = new QxTreeFolder(clsName, "icons/16/Class.gif", "icons/16/Class.gif");        
				node.addEventListener("dragstart", handleDragStart);
				node.addEventListener("dragdrop", handleDragDrop); 
				node.addEventListener("dragover", handleDragOver);
				node.addEventListener("dragout", handleDragOut);
				node.setUserData("ID", clsID);
				if(null != currentNode)
					currentNode.add(node);	
				else
					treeSource.add(node);
			}
			if(null != currentNode)
				currentNode.open();
			editStatus.setValue("类信息已经获得");
		};
		
		function getInstances(clsID){
			editStatus.setValue("正在获取类下实例列表的信息……");
			var strParams = 'type=inslist' + '&clsid=' + clsID;
			var url = href + '?' + strParams;
//			alert(url);
			var loader1 = new net.ContentLoader(url,setInstances,null,"POST",null); 
		};
		
		function setInstances(){					
//			alert("get");
      		var text = this.req.responseText; 					
//			alert(text);
			var parser = new DOMParser();
			text = parser.parseFromString(text, "text/xml");
			var list = text.getElementsByTagName("insID");
			insList.removeAll();
			for(var i=0; i<list.length; i++){
				var insID = text.getElementsByTagName("insID")[i].firstChild.data;
				var insName = text.getElementsByTagName("insName")[i].firstChild.data;
				var item = new QxListItem(insName/*, "icons/16/Instance.gif"*/);	
				item.setUserData("ID", insID);
				insList.add(item);
			}
			editStatus.setValue("已经获取类下实例列表的信息");
		};
		
		function setCls(clsID, clsName){
			//可能是新建的类，其id可能为空
			var strParams = "type=setCls" + "&clsid=" + clsID + "&clsname=" + clsName;
			if(clsID == -1)
				strParams = strParams + "&fclsid=" + currentNode.getParentFolder().getUserData("ID");
			var url = href + '?' + strParams;
			alert(url);
			var loader1 = new net.ContentLoader(url,setClsID,null,"POST",null); 
		};

		function setClsID(){
			if(currentNode.getUserData("ID") == -1){							
//				alert("get");
	      		var text = this.req.responseText; 					
//				alert(text);
				var parser = new DOMParser();
				text = parser.parseFromString(text, "text/xml");
				var clsID = text.getElementsByTagName("ID")[i].firstChild.data;
				currentNode.setUserData("ID", clsID);
			}
		}
		
		function deleteCls(clsID){
			var strParams = "type=deleteCls" + "&clsid=" + clsID;
			var url = href + '?' + strParams;
			alert(url);
			var loader1 = new net.ContentLoader(url,deleteResponse,null,"POST",null);
		};
		
		function deleteResponse(){
			alert("已经删除!");
		};
		
		function deleteIns(insID){
			var strParams = "type=deleteIns" + "&insid=" + insID;			
			var url = href + '?' + strParams;
			alert(url);
			var loader1 = new net.ContentLoader(url,deleteResponse,null,"POST",null);
		};
		
		function conceptIns(insID, clsID, text){
			but_insCreate.setEnabled(false);
			but_insDelete.setEnabled(false);
			but_insBrowse.setEnabled(false);
			submit.setEnabled(false);
			
			var strParams = "type=conceptIns" + "&insid=" + insID + "&clsid=" + clsID + "&xml=" + text;
			var url = href + strParams;
			alert(url);
			var loader1 = new net.ContentLoader(url,setClsID,null,"POST",null); 
		};

		function setConceptInsID(text){
//			alert("get");			
			var currentItem = insList.getManager().getSelectedItem();
			if((currentItem != null) && (currentItem.getUserData("ID") == -1)){
	      		var text = this.req.responseText;
				var parser = new DOMParser();
				text = parser.parseFromString(text, "text/xml");
				var id = text.getElementsByTagName("ID")[0].firstChild.data;
				if(currentItem != null){
					currentItem.setUserData("ID", ""+id);
				}
				else
					alert("current");
			}
			alert("提交成功！");
			but_insCreate.setEnabled(true);
			but_insDelete.setEnabled(true);
			but_insBrowse.setEnabled(true);
			submit.setEnabled(true);
		}
		
		function getInsDetail(insID){         
			editStatus.setValue("正在获取实例定义信息……");                                 
			var strParams = 'type=insdetail' + '&insid=' + insID;                          
			var url = href + '?' + strParams;  
//			alert(url);
			var loader1 = new net.ContentLoader(url,setInsDetail,null,"POST",null); 
		};

		function setInsDetail(){					
//			alert("get");
      		var text = this.req.responseText; 					
//			alert(text);
			var parser = new DOMParser();
			text = parser.parseFromString(text, "text/xml");
			var list = text.getElementsByTagName("ConceptName");
			for(var i=0; i<list.length; i++){
				tCurrentConceptInput.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("EditAuthor");
			for(var i=0; i<list.length; i++){
				tEditorInput.setValue(list[0].firstChild.data);
			}		
			var list = text.getElementsByTagName("EditTime");
			for(var i=0; i<list.length; i++){
				tDateInput.setValue(list[0].firstChild.data);
			}	
			var list = text.getElementsByTagName("ConceptStatus");
			for(var i=0; i<list.length; i++){
				status.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("Reason");
			for(var i=0; i<list.length; i++){
				reason.setValue(list[0].firstChild.data);
			}
			var list = text.documentElement.getElementsByTagName("SemanticType");
			for(var i=0; i<list.length; i++){
				var name = list[i].firstChild.data;
				var id = list[i].getAttribute("ID");
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				typeList.add(item);
			}
			list = text.documentElement.getElementsByTagName("Definition");
			for(var i=0; i<list.length; i++){
				var name = list[i].firstChild.data;
				var id = list[i].getAttribute("ID");
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				defList.add(item);
			}
			list = text.documentElement.getElementsByTagName("Explanation");
			for(var i=0; i<list.length; i++){
				var name = list[i].firstChild.data;
				var id = list[i].getAttribute("ID");
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				expList.add(item);
			}
			list = text.documentElement.getElementsByTagName("Alias");
			for(var i=0; i<list.length; i++){
				var name = list[i].firstChild.data;
				var id = list[i].getAttribute("ID");
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				aliasList.add(item);
			}
			list = text.documentElement.getElementsByTagName("RelatedConcepts");
			for(var i=0; i<list.length; i++){
				var name = list[i].firstChild.data;
				var id = list[i].getAttribute("ID");
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				ceptsList.add(item);
			}
			editStatus.setValue("已经获得实例定义信息");
		};

		function getTypes(){
			if(type.isEmpty()){
				editStatus.setValue("正在获取语义类型列表……");
				var strParams = "type=typelist";
				var url = href + '?' + strParams;  
				alert(url);
				var loader1 = new net.ContentLoader(url,setTypeList,null,"POST",null); 
			}
		};

		function setTypeList(){
//			alert("get");
      		var text = this.req.responseText; 
			var parser = new DOMParser();
			text = parser.parseFromString(text, "text/xml");
			var list = text.documentElement.getElementsByTagName("typeID");
			for(var i=0; i<list.length; i++){
				var id = list[i].firstChild.data;
				var name = text.documentElement.getElementsByTagName("typeName")[i].firstChild.data;
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				type.add(item);
			}
			editStatus.setValue("已经获取语义类型列表");
		};

		function getRelas(){
			if(rela.isEmpty()){
				editStatus.setValue("正在获取语义关系列表……");
				var strParams = "type=relalist";
				var url = href + '?' + strParams;  
				alert(url);
				var loader1 = new net.ContentLoader(url,setRelaList,null,"POST",null); 
			}
		}

		function setRelaList(text){
//			alert("get");
      		var text = this.req.responseText; 
			var parser = new DOMParser();
			text = parser.parseFromString(text, "text/xml");
			var list = text.documentElement.getElementsByTagName("relaID");
			for(var i=0; i<list.length; i++){
				var id = list[i].firstChild.data;
				var name = text.documentElement.getElementsByTagName("relaName")[i].firstChild.data;
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				rela.add(item);
			}
			editStatus.setValue("已经获取语义关系列表");
		};

		function getBooks(){
			if(source.isEmpty()){
				editStatus.setValue("正在获取工具书列表……");
				var strParams = "type=booklist";
				var url = href + '?' + strParams;  
				alert(url);
				var loader1 = new net.ContentLoader(url,setBookList,null,"POST",null); 
			}
		};

		function setBookList(){
//			alert("get");
			//测试数据
/*			for(var i=1; i<20; i++){
			 	var item = new QxListItem("Book" + i);
			 	item.setUserData("ID", "ID"+i);
			 	source.add(item);
			}*/
      		var text = this.req.responseText; 
			var parser = new DOMParser();
			text = parser.parseFromString(text, "text/xml");
			var list = text.documentElement.getElementsByTagName("bookID");
			for(var i=0; (i<list.length) && (i <20); i++){
				var id = list[i].firstChild.data;
				var name = text.documentElement.getElementsByTagName("bookName")[i].firstChild.data;
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				source.add(item);
			}
			editStatus.setValue("已经获得工具书列表");
		};
		
		function defIns(defID, text){
			var strParams = "type=defIns" + "&defid=" + defID + "&xml=" + text;
			var url = href + '?' + strParams;  
			alert(url);
			var loader1 = new net.ContentLoader(url,setDefInsID,null,"POST",null); 
		};

		function setDefInsID(){
//			alert("get");			
			var currentItem = defList.getManager().getSelectedItem();
			if((currentItem != null) && (currentItem.getUserData("ID") == -1)){
	      		var text = this.req.responseText;
				var parser = new DOMParser();
				text = parser.parseFromString(text, "text/xml");
				var id = text.getElementsByTagName("ID")[0].firstChild.data;
				currentItem.setUserData("ID", ""+id);
			}
			but_defCreate.setEnabled(true);
			but_defDelete.setEnabled(true);
			but_defBrowse.setEnabled(true);
		};

		function getDefDetail(defID){   
			editStatus.setValue("正在获取概念定义实例……");                                   
			var strParams = "type=def" + "&defid=" + defID; 
			var url = href + '?' + strParams;  
			alert(url);
			var loader1 = new net.ContentLoader(url,setDefDetail,null,"POST",null); 
		};

		function setDefDetail(){
//			alert("get");
      		var text = this.req.responseText;
			var parser = new DOMParser();
			text = parser.parseFromString(text, "text/xml");
			def.setValue("");
			if(defSource.getChildren().length > 0)
				defSource.removeAll();
			var list = text.getElementsByTagName("Definition");
			for(var i=0; i<list.length; i++){
				def.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("DefiSource");
			for(var i=0; i<list.length; i++){
				var name = list[i].firstChild.data;
				var id = list[i].getAttribute("ID");
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				defSource.add(item);
			}	
			defEditWin.open();
			editStatus.setValue("已经获得概念定义实例");
		};
		//未测试，defid去处相关的index，但是可能有其他实例的牵扯
		function defDelete(defID){			
			var strParams = "type=defDel" + "&defid=" + defID;
			var url = href + '?' + strParams;  
			alert(url);
			var loader1 = new net.ContentLoader(url,null,null,"POST",null);
		}
		
		function expIns(expID, text){
			var strParams = "type=expIns" + "&expid=" + expID + "&xml=" + text;
			var url = href + '?' + strParams;  
			alert(url);
			var loader1 = new net.ContentLoader(url,setExpInsID,null,"POST",null); 
		};

		function setExpInsID(){
//			alert("get");
			var currentItem = expList.getManager().getSelectedItem();
			if((currentItem != null) && (currentItem.getUserData("ID") == -1)){
	      		var text = this.req.responseText;
				var parser = new DOMParser();
				text = parser.parseFromString(text, "text/xml");
				var id = text.getElementsByTagName("ID")[0].firstChild.data;
				currentItem.setUserData("ID", ""+id);
			}
			but_expCreate.setEnabled(true);
			but_expDelete.setEnabled(true);
			but_expBrowse.setEnabled(true);
		};

		function getExpDetail(expID){   
			editStatus.setValue("正在获取概念释义实例……");                                      
			var strParams = "type=exp" + '&expid=' + expID; 
			var url = href + '?' + strParams;  
			alert(url);
			var loader1 = new net.ContentLoader(url,setExpDetail,null,"POST",null); 
		};

		function setExpDetail(){
//			alert("get");
      		var text = this.req.responseText;
			var parser = new DOMParser();
			text = parser.parseFromString(text, "text/xml");
			exp.setValue("");
			if(expSource.getChildren().length > 0)
				expSource.removeAll();
			var list = text.getElementsByTagName("Explanation");
			for(var i=0; i<list.length; i++){
				exp.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("DefiSource");
			for(var i=0; i<list.length; i++){
				var name = list[i].firstChild.data;
				var id = list[i].getAttribute("ID");
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				expSource.add(item);
			}
			expEditWin.open();
			editStatus.setValue("已经获得概念释义实例");
		};
		
		function ceptsIns(ceptsID, text){
			var strParams = "type=ceptsIns" + "&ceptsid=" + ceptsID + "&xml=" + text;
			var url = href + '?' + strParams;  
			alert(url);
			var loader1 = new net.ContentLoader(url,setCeptsInsID,null,"POST",null);
		};

		function setCeptsInsID(text){			
//			alert("get");
			var currentItem = ceptsList.getManager().getSelectedItem();
			if((currentItem != null) && (currentItem.getUserData("ID") == -1)){
	      		var text = this.req.responseText;
				var parser = new DOMParser();
				text = parser.parseFromString(text, "text/xml");
				var id = text.getElementsByTagName("ID")[0].firstChild.data;
				currentItem.setUserData("ID", ""+id);  
			}      
	        but_ceptsCreate.setEnabled(true);
			but_ceptsDelete.setEnabled(true);
			but_ceptsBrowse.setEnabled(true);
		};

		function getCeptsDetail(ceptsID){     
			editStatus.setValue("正在获取各种相关概念词实例……");                                    
			var strParams = 'type=cepts' + '&ceptsid=' + ceptsID;  
			var url = href + '?' + strParams;  
			alert(url);
			var loader1 = new net.ContentLoader(url,setCeptsDetail,null,"POST",null); 
		};	

		function setCeptsDetail(){
//			alert("get");
      		var text = this.req.responseText;
			var parser = new DOMParser();
			text = parser.parseFromString(text, "text/xml");
			cepts.setValue("");
			descript.setValue("");
			if(relaSource.getChildren().length > 0)
				relaSource.removeAll();
			if(relaList.getChildren().length > 0)
				relaList.removeAll();
			var list = text.getElementsByTagName("RelatedConcept");
			for(var i=0; i<list.length; i++){
				cepts.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("RelaDescription");
			for(var i=0; i<list.length; i++){
				descript.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("SemanticSource");
			for(var i=0; i<list.length; i++){
				var name = list[i].firstChild.data;
				var id = list[i].getAttribute("ID");
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				relaSource.add(item);
			}
			var list = text.getElementsByTagName("SemanticRela");
			for(var i=0; i<list.length; i++){
				var name = list[i].firstChild.data;
				var id = list[i].getAttribute("ID");
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				relaList.add(item);
			}
			ceptsEditWin.open();
			editStatus.setValue("已经获得各种相关概念词实例");
		};

		function aliasIns(aliasID, text){
			var strParams = "type=aliasIns" + "&aliasid=" + aliasID + "&xml=" + text;
			var url = href + '?' + strParams;  
			alert(url);
			var loader1 = new net.ContentLoader(url,setAliasInsID,null,"POST",null); 
		};

		function setAliasInsID(text){
//			alert("get");
			var currentItem = aliasList.getManager().getSelectedItem();
			if((currentItem != null) && (currentItem.getUserData("ID") == -1)){
	      		var text = this.req.responseText;
				var parser = new DOMParser();
				text = parser.parseFromString(text, "text/xml");
				var id = text.getElementsByTagName("ID")[0].firstChild.data;
				currentItem.setUserData("ID", ""+id);
			}         
      		but_aliasCreate.setEnabled(true);
	  		but_aliasDelete.setEnabled(true);
	  		but_aliasBrowse.setEnabled(true);
		};

		function getAliasDetail(aliasID){
			editStatus.setValue("正在获取名称字符类实例……");
			var strParams = 'type=alias' + '&aliasid=' + aliasID;  
			var url = href + '?' + strParams;  
			alert(url);
			var loader1 = new net.ContentLoader(url,setAliasDetail,null,"POST",null); 
		};

		function setAliasDetail(){
//			alert("get");
      		var text = this.req.responseText;
			var parser = new DOMParser();
			text = parser.parseFromString(text, "text/xml");
			alias.setValue("");
			nameType.setValue("");
			nameDate.setValue("");
			aliasStatus.setValue("");
			aliasReason.setValue("");
			if(aliasSource.getChildren().length > 0)
				aliasSource.removeAll();
			var list = text.getElementsByTagName("Alias");
			for(var i=0; i<list.length; i++){
				alias.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("NameType");
			for(var i=0; i<list.length; i++){
				nameType.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("NameTime");
			for(var i=0; i<list.length; i++){
				nameDate.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("AliasStatus");
			for(var i=0; i<list.length; i++){
				aliasStatus.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("Reason");
			for(var i=0; i<list.length; i++){
				aliasReason.setValue(list[0].firstChild.data);
			}
			var list = text.getElementsByTagName("NameSource");
			for(var i=0; i<list.length; i++){
				var name = list[i].firstChild.data;
				var id = list[i].getAttribute("ID");
				var item = new QxListItem(name/*, "icons/16/Instance.gif"*/);
				item.setUserData("ID", id);
				aliasSource.add(item);
			}
			aliasEditWin.open();
			editStatus.setValue("已经获得名称字符类实例");
		};
		
		function treeAct(node, value){
			node.setEnabled(value);
			var children = node.getChildren();
			alert("act");
			alert(children.length);
			for(var i=0; i<children.length; i++){
				treeAct(children[i], value);
			}
		};
    };
  </script>
</body>
</html>